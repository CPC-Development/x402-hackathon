services:
  hardhat:
    build:
      context: ../contracts/hardhat
      dockerfile: Dockerfile
    profiles: ["hardhat"]
    ports:
      - "${HARDHAT_PORT:-8545}:8545"
    environment:
      - HARDHAT_MNEMONIC=${HARDHAT_MNEMONIC:-}
      - IGNITION_CREATE2_SALT=${IGNITION_CREATE2_SALT:-}
    volumes:
      - ../contracts/hardhat/ignition:/app/ignition

  postgres:
    image: postgres:16
    profiles: ["sequencer"]
    environment:
      POSTGRES_USER: x402
      POSTGRES_PASSWORD: x402
      POSTGRES_DB: x402
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - x402_pg:/var/lib/postgresql/data

  facilitator:
    build:
      context: ../facilitator/x402-rs
      dockerfile: Dockerfile
    profiles: ["facilitator"]
    depends_on:
      - sequencer
    ports:
      - "${FACILITATOR_PORT:-8080}:8080"
    volumes:
      - ./facilitator-config.json:/app/config.json:ro
    environment:
      - RUST_LOG=info

  sequencer:
    build:
      context: ../apps/sequencer
      dockerfile: Dockerfile
    profiles: ["sequencer"]
    depends_on:
      - postgres
    ports:
      - "${SEQUENCER_PORT:-4001}:4001"
    environment:
      DATABASE_URL: "postgres://x402:x402@postgres:5432/x402"
      RPC_URL: "${RPC_URL:-http://hardhat:8545}"
      CHAIN_ID: "${CHAIN_ID:-31337}"
      CHANNEL_MANAGER_ADDRESS: "${CHANNEL_MANAGER_ADDRESS:-}"
      MAX_RECIPIENTS: "${MAX_RECIPIENTS:-30}"
      SEQUENCER_PRIVATE_KEY: "${SEQUENCER_PRIVATE_KEY:-}"
      PORT: "4001"

  service:
    build:
      context: ../apps/service
      dockerfile: Dockerfile
    profiles: ["todo"]
    command: ["sh", "-c", "echo TODO: add service Dockerfile; sleep infinity"]
    ports:
      - "${SERVICE_PORT:-4000}:4000"

networks:
  default:
    name: x402_demo

volumes:
  x402_pg:
